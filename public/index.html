<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JobFit Agent</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.svg" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    /* Focus styles for keyboard navigation */
    :focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    button:focus:not(:focus-visible),
    input:focus:not(:focus-visible),
    textarea:focus:not(:focus-visible),
    select:focus:not(:focus-visible) {
      outline: none;
    }

    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface2: #232736;
      --border: #2e3348;
      --text: #e4e6f0;
      --text-dim: #8b8fa3;
      --accent: #6c5ce7;
      --accent-light: #a29bfe;
      --green: #00b894;
      --green-bg: rgba(0,184,148,0.12);
      --yellow: #fdcb6e;
      --yellow-bg: rgba(253,203,110,0.12);
      --red: #ff6b6b;
      --red-bg: rgba(255,107,107,0.12);
      --blue: #74b9ff;
      --blue-bg: rgba(116,185,255,0.12);
      --orange: #e17055;
      --radius: 12px;
      --radius-sm: 8px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .app { max-width: 1100px; margin: 0 auto; padding: 32px 24px; }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 16px;
    }
    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-light), var(--blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
    }
    .header p { color: var(--text-dim); font-size: 1rem; }

    /* Nav */
    .nav {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin-bottom: 32px;
      border-bottom: 1px solid var(--border);
    }
    .nav-tab {
      padding: 12px 28px;
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      font-family: inherit;
    }
    .nav-tab:hover { color: var(--text); }
    .nav-tab.active { color: var(--accent-light); border-bottom-color: var(--accent); }

    /* Card */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 20px;
    }
    .card h2 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Form */
    textarea {
      width: 100%;
      min-height: 160px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: inherit;
      font-size: 0.9rem;
      padding: 12px 16px;
      resize: vertical;
      transition: border-color 0.2s;
    }
    textarea:focus { border-color: var(--accent); }
    textarea::placeholder { color: var(--text-dim); }

    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-dim);
      margin-bottom: 6px;
    }

    .form-group { margin-bottom: 16px; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 32px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #5f3dc4);
      color: white;
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(108,92,231,0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-sm {
      padding: 8px 18px;
      font-size: 0.85rem;
    }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-dim);
    }
    .btn-outline:hover { border-color: var(--accent); color: var(--text); }

    .btn-center { display: flex; justify-content: center; margin-top: 8px; }

    /* Input fields */
    input[type="text"], input[type="url"] {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: inherit;
      font-size: 0.9rem;
      padding: 10px 16px;
      transition: border-color 0.2s;
    }
    input[type="text"]:focus, input[type="url"]:focus { border-color: var(--accent); }
    input[type="text"]::placeholder, input[type="url"]::placeholder { color: var(--text-dim); }

    .or-divider {
      text-align: center;
      color: var(--text-dim);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      margin: 12px 0;
      position: relative;
    }
    .or-divider::before, .or-divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background: var(--border);
    }
    .or-divider::before { left: 0; }
    .or-divider::after { right: 0; }

    .file-upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--surface2);
    }
    .file-upload-area:hover { border-color: var(--accent); background: rgba(108,92,231,0.05); }
    .file-upload-area.has-file { border-color: var(--green); background: var(--green-bg); }
    .file-upload-label { color: var(--text-dim); font-size: 0.85rem; }
    .file-upload-label strong { color: var(--accent-light); }
    .file-name { color: var(--green); font-weight: 600; font-size: 0.9rem; }
    .file-remove {
      background: none;
      border: none;
      color: var(--red);
      cursor: pointer;
      font-size: 0.8rem;
      margin-left: 8px;
      padding: 2px 6px;
    }

    /* Score */
    .score-section { text-align: center; padding: 32px; }
    .score-ring {
      width: 140px; height: 140px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      position: relative;
    }
    .score-ring svg { position: absolute; top: 0; left: 0; transform: rotate(-90deg); }
    .score-number { font-size: 2.5rem; font-weight: 700; z-index: 1; }
    .score-label { color: var(--text-dim); font-size: 0.9rem; }

    .score-ring-sm {
      width: 48px; height: 48px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
      flex-shrink: 0;
    }
    .score-ring-sm svg { position: absolute; top: 0; left: 0; transform: rotate(-90deg); }
    .score-ring-sm .score-number-sm { font-size: 0.8rem; font-weight: 700; z-index: 1; }

    .stats-row {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    .stat { text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: 700; }
    .stat-label { font-size: 0.8rem; color: var(--text-dim); margin-top: 2px; }

    /* Tags */
    .tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .tag-strong { background: var(--green-bg); color: var(--green); }
    .tag-moderate { background: var(--yellow-bg); color: var(--yellow); }
    .tag-weak { background: var(--red-bg); color: var(--red); }
    .tag-critical { background: var(--red-bg); color: var(--red); }
    .tag-minor { background: var(--blue-bg); color: var(--blue); }
    .tag-required { background: var(--red-bg); color: var(--red); }
    .tag-preferred { background: var(--yellow-bg); color: var(--yellow); }
    .tag-nice-to-have { background: var(--blue-bg); color: var(--blue); }

    /* Match items */
    .match-item {
      background: var(--surface2);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      margin-bottom: 10px;
    }
    .match-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }
    .match-skill { font-weight: 600; font-size: 0.95rem; }
    .match-evidence { font-size: 0.85rem; color: var(--text-dim); }

    /* Reframe */
    .reframe-item {
      background: var(--surface2);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      margin-bottom: 10px;
      border-left: 3px solid var(--accent);
    }
    .reframe-from { font-size: 0.85rem; color: var(--text-dim); margin-bottom: 6px; }
    .reframe-arrow { color: var(--accent-light); margin: 6px 0; font-size: 0.85rem; }
    .reframe-to { font-size: 0.9rem; font-weight: 500; color: var(--green); }
    .reframe-target { font-size: 0.8rem; color: var(--text-dim); margin-top: 6px; }

    /* List items */
    .list-item {
      background: var(--surface2);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    /* Two column layout */
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .two-col { grid-template-columns: 1fr; } }

    /* Three column layout */
    .three-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .three-col { grid-template-columns: 1fr; } }

    /* Job info */
    .job-info { display: flex; flex-wrap: wrap; gap: 20px; }
    .job-field label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
    .job-field p { font-size: 0.95rem; font-weight: 500; margin-top: 2px; }

    /* Tech stack pills */
    .tech-pills { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .tech-pill {
      padding: 4px 10px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    /* Loading */
    .loading { text-align: center; padding: 48px; }
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-step { color: var(--text-dim); font-size: 0.9rem; margin-top: 8px; }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      flex: 1;
      max-width: 140px;
      opacity: 0.35;
      transition: opacity 0.3s;
    }
    .progress-step.active, .progress-step.completed { opacity: 1; }
    .step-indicator {
      width: 36px; height: 36px;
      border-radius: 50%;
      background: var(--surface2);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-dim);
      transition: all 0.3s;
    }
    .progress-step.active .step-indicator {
      border-color: var(--accent);
      color: var(--accent-light);
    }
    .progress-step.completed .step-indicator {
      background: var(--green);
      border-color: var(--green);
      color: white;
    }
    .step-label {
      font-size: 0.75rem;
      color: var(--text-dim);
      text-align: center;
    }
    .progress-step.active .step-label { color: var(--text); }
    .spinner-sm {
      width: 16px; height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Progress Bar */
    .progress-bar-track {
      height: 4px;
      background: var(--surface2);
      border-radius: 2px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    /* Skeleton placeholder */
    .skeleton-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      position: relative;
      overflow: hidden;
    }
    .skeleton-card::after {
      content: '';
      position: absolute;
      top: 0; left: -100%; width: 200%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { to { transform: translateX(50%); } }

    /* Section Nav */
    .section-nav {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(15, 17, 23, 0.92);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
      padding: 0 16px;
      margin: 0 -24px 20px;
      display: flex;
      gap: 4px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .section-nav::-webkit-scrollbar { display: none; }
    .section-nav-link {
      padding: 10px 16px;
      font-size: 0.8rem;
      color: var(--text-dim);
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
      font-family: inherit;
    }
    .section-nav-link:hover { color: var(--text); }
    .section-nav-link.active { color: var(--accent-light); border-bottom-color: var(--accent); }

    /* Fade in animation */
    .fade-in {
      animation: fadeIn 0.4s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Metadata */
    .meta-row {
      display: flex;
      gap: 24px;
      justify-content: center;
      color: var(--text-dim);
      font-size: 0.8rem;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    /* Error */
    .error-box {
      background: var(--red-bg);
      border: 1px solid rgba(255,107,107,0.3);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      color: var(--red);
      font-size: 0.9rem;
    }

    /* Section toggle */
    .section-header {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .section-header .count {
      background: var(--surface2);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0;
    }
    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      font-family: inherit;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent-light); border-bottom-color: var(--accent); }

    /* Content block (cover letter, etc) */
    .content-block {
      background: var(--surface2);
      border-radius: var(--radius-sm);
      padding: 20px 24px;
      font-size: 0.9rem;
      line-height: 1.8;
      white-space: pre-wrap;
      color: var(--text);
    }

    /* Copy button */
    .btn-copy {
      padding: 6px 14px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      white-space: nowrap;
    }
    .btn-copy:hover { border-color: var(--accent); color: var(--text); }

    /* Validation badge */
    .validation-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .validation-passed { background: var(--green-bg); color: var(--green); }
    .validation-failed { background: var(--red-bg); color: var(--red); }

    /* Table */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th {
      text-align: left;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .data-table td {
      padding: 14px 12px;
      font-size: 0.9rem;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    .data-table tr:last-child td { border-bottom: none; }
    .data-table tr:hover td { background: rgba(108,92,231,0.04); }
    .data-table .text-right { text-align: right; }
    .data-table .text-center { text-align: center; }

    /* Checkbox */
    .checkbox {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    /* Select */
    select {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: inherit;
      font-size: 0.85rem;
      padding: 6px 12px;
      cursor: pointer;
    }
    select:focus { border-color: var(--accent); }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-dim);
    }
    .empty-state h3 { font-size: 1.1rem; margin-bottom: 8px; color: var(--text); }

    /* Toolbar */
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    /* Compare cards */
    .compare-grid { display: grid; gap: 20px; }
    .compare-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      text-align: center;
    }
    .compare-card.best { border-color: var(--green); }
    .compare-card h3 { font-size: 1rem; font-weight: 600; margin-bottom: 4px; }
    .compare-card .role-text { font-size: 0.85rem; color: var(--text-dim); margin-bottom: 16px; }
    .compare-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 0.85rem;
      border-bottom: 1px solid var(--border);
    }
    .compare-row:last-child { border-bottom: none; }
    .compare-label { color: var(--text-dim); }

    /* Totals row */
    .totals-row td {
      font-weight: 700;
      border-top: 2px solid var(--border);
      padding-top: 16px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // --- Helpers ---
    function formatTokens(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
      return '' + n;
    }

    // --- Score Ring ---
    function getScoreFitLabel(score) {
      if (score >= 80) return 'Strong Fit';
      if (score >= 60) return 'Moderate Fit';
      return 'Weak Fit';
    }

    function ScoreRing({ score, size }) {
      const sz = size || 140;
      const strokeWidth = sz > 60 ? 8 : 4;
      const radius = (sz / 2) - strokeWidth;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (score / 100) * circumference;
      const color = score >= 80 ? '#00b894' : score >= 60 ? '#fdcb6e' : '#ff6b6b';

      return (
        <div className={sz > 60 ? 'score-ring' : 'score-ring-sm'} style={sz <= 60 ? { width: sz, height: sz } : undefined}
          aria-label={'Fit score: ' + score + ' out of 100, ' + getScoreFitLabel(score)} role="img">
          <svg width={sz} height={sz} aria-hidden="true">
            <circle cx={sz/2} cy={sz/2} r={radius} fill="none" stroke="#2e3348" strokeWidth={strokeWidth} />
            <circle cx={sz/2} cy={sz/2} r={radius} fill="none" stroke={color} strokeWidth={strokeWidth}
              strokeDasharray={circumference} strokeDashoffset={offset}
              strokeLinecap="round" style={{ transition: 'stroke-dashoffset 1s ease' }} />
          </svg>
          <span className={sz > 60 ? 'score-number' : 'score-number-sm'} style={{ color }}>{score}</span>
        </div>
      );
    }

    // --- Match Card ---
    function MatchCard({ item }) {
      return (
        <div className="match-item">
          <div className="match-header">
            <span className="match-skill">{item.skill}</span>
            <span className={`tag tag-${item.strength}`}>{item.strength}</span>
          </div>
          <div className="match-evidence">{item.evidence}</div>
        </div>
      );
    }

    // --- Gap Card ---
    function GapCard({ item }) {
      return (
        <div className="match-item">
          <div className="match-header">
            <span className="match-skill">{item.skill}</span>
            <span className={`tag tag-${item.severity}`}>{item.severity}</span>
          </div>
          <div className="match-evidence">{item.suggestion}</div>
        </div>
      );
    }

    // --- Reframe Card ---
    function ReframeCard({ item }) {
      return (
        <div className="reframe-item">
          <div className="reframe-from">{item.existingExperience}</div>
          <div className="reframe-arrow">&#x2192; Reframe as:</div>
          <div className="reframe-to">{item.reframedAs}</div>
          <div className="reframe-target">Targets: {item.targetRequirement}</div>
        </div>
      );
    }

    // --- Copy Button ---
    function CopyButton({ text }) {
      const [copied, setCopied] = useState(false);
      const handleCopy = useCallback(() => {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        });
      }, [text]);
      return (
        <button className="btn-copy" onClick={handleCopy} aria-label="Copy to clipboard">
          {copied ? '\u2713 Copied!' : 'Copy'}
        </button>
      );
    }

    // --- Output Tabs ---
    function OutputTabs({ outputs, validation }) {
      const [activeTab, setActiveTab] = useState('coverLetter');

      if (!outputs) return null;

      const tabs = [
        { id: 'coverLetter', label: 'Cover Letter', icon: '\u2709\uFE0F' },
        { id: 'tailoredBullets', label: 'Resume Bullets', icon: '\uD83D\uDCDD' },
        { id: 'interviewPrep', label: 'Interview Prep', icon: '\uD83C\uDFA4' },
      ];

      const activeContent = activeTab === 'coverLetter' ? outputs.coverLetter
        : activeTab === 'tailoredBullets' ? outputs.tailoredBullets
        : outputs.interviewPrep;

      return (
        <div className="card">
          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8 }}>
            <h2>{'\uD83D\uDCE6'} Generated Outputs</h2>
            {validation && (
              <span className={`validation-badge ${validation.passed ? 'validation-passed' : 'validation-failed'}`}>
                {validation.passed ? '\u2713 Validated' : '\u26A0 Issues'}
              </span>
            )}
          </div>
          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
            <div className="tabs" style={{ marginBottom: 0 }}>
              {tabs.map(tab => (
                <button
                  key={tab.id}
                  className={`tab ${activeTab === tab.id ? 'active' : ''}`}
                  onClick={() => setActiveTab(tab.id)}
                >
                  {tab.icon} {tab.label}
                </button>
              ))}
            </div>
            {activeContent && <CopyButton text={activeContent} />}
          </div>
          <div className="content-block" style={{ marginTop: 16 }}>
            {activeContent || 'No content generated.'}
          </div>
        </div>
      );
    }

    // --- Section Nav (sticky scroll-spy) ---
    const RESULT_SECTIONS = [
      { id: 'section-job-overview', label: 'Job Overview' },
      { id: 'section-fit-score', label: 'Fit Score' },
      { id: 'section-matches', label: 'Matches & Gaps' },
      { id: 'section-outputs', label: 'Outputs' },
      { id: 'section-metadata', label: 'Details' },
    ];

    function SectionNav() {
      const [activeId, setActiveId] = useState(RESULT_SECTIONS[0].id);

      useEffect(() => {
        const observer = new IntersectionObserver(
          (entries) => {
            for (const entry of entries) {
              if (entry.isIntersecting) {
                setActiveId(entry.target.id);
              }
            }
          },
          { rootMargin: '-80px 0px -60% 0px', threshold: 0.1 }
        );

        RESULT_SECTIONS.forEach(function(s) {
          const el = document.getElementById(s.id);
          if (el) observer.observe(el);
        });

        return () => observer.disconnect();
      }, []);

      const scrollTo = useCallback((id) => {
        const el = document.getElementById(id);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, []);

      return (
        <div className="section-nav" role="navigation" aria-label="Results sections">
          {RESULT_SECTIONS.map(function(s) {
            return React.createElement('button', {
              key: s.id,
              className: 'section-nav-link' + (activeId === s.id ? ' active' : ''),
              onClick: function() { scrollTo(s.id); }
            }, s.label);
          })}
        </div>
      );
    }

    // --- Progressive Results View (during streaming) ---
    function ProgressiveResults({ data }) {
      if (!data) return null;

      return (
        React.createElement('div', null,
          // Job Overview (from parsedJD)
          data.parsedJD ? (
            React.createElement('div', { className: 'card fade-in' },
              React.createElement('h2', null, '\uD83C\uDFE2 Job Overview'),
              React.createElement('div', { className: 'job-info' },
                React.createElement('div', { className: 'job-field' },
                  React.createElement('label', null, 'Company'),
                  React.createElement('p', null, data.parsedJD.company)
                ),
                React.createElement('div', { className: 'job-field' },
                  React.createElement('label', null, 'Role'),
                  React.createElement('p', null, data.parsedJD.role)
                ),
                React.createElement('div', { className: 'job-field' },
                  React.createElement('label', null, 'Level'),
                  React.createElement('p', null, data.parsedJD.level)
                ),
                data.parsedJD.team && React.createElement('div', { className: 'job-field' },
                  React.createElement('label', null, 'Team'),
                  React.createElement('p', null, data.parsedJD.team)
                )
              ),
              React.createElement('div', { style: { marginTop: 16 } },
                React.createElement('label', null, 'Tech Stack'),
                React.createElement('div', { className: 'tech-pills' },
                  data.parsedJD.techStack.map(function(t, i) {
                    return React.createElement('span', { className: 'tech-pill', key: i }, t);
                  })
                )
              )
            )
          ) : React.createElement(Skeleton, { height: 120 }),

          // Fit Score (from fitAnalysis)
          data.fitAnalysis ? (
            React.createElement('div', { className: 'card score-section fade-in' },
              React.createElement(ScoreRing, { score: data.fitAnalysis.overallScore, size: 140 }),
              React.createElement('div', { className: 'score-label' }, 'Overall Fit Score'),
              React.createElement('div', { className: 'stats-row' },
                React.createElement('div', { className: 'stat' },
                  React.createElement('div', { className: 'stat-value', style: { color: 'var(--green)' } }, data.fitAnalysis.strongMatches.length),
                  React.createElement('div', { className: 'stat-label' }, 'Strong Matches')
                ),
                React.createElement('div', { className: 'stat' },
                  React.createElement('div', { className: 'stat-value', style: { color: 'var(--yellow)' } }, data.fitAnalysis.partialMatches.length),
                  React.createElement('div', { className: 'stat-label' }, 'Partial Matches')
                ),
                React.createElement('div', { className: 'stat' },
                  React.createElement('div', { className: 'stat-value', style: { color: 'var(--red)' } }, data.fitAnalysis.gaps.length),
                  React.createElement('div', { className: 'stat-label' }, 'Gaps')
                ),
                React.createElement('div', { className: 'stat' },
                  React.createElement('div', { className: 'stat-value', style: { color: 'var(--accent-light)' } }, data.fitAnalysis.reframingSuggestions.length),
                  React.createElement('div', { className: 'stat-label' }, 'Reframe Opps')
                )
              )
            )
          ) : data.parsedJD ? React.createElement(Skeleton, { height: 200 }) : null,

          // Strong Matches and Gaps
          data.fitAnalysis ? (
            React.createElement('div', { className: 'two-col fade-in' },
              React.createElement('div', { className: 'card' },
                React.createElement('h2', null, '\u2705 Strong Matches'),
                data.fitAnalysis.strongMatches.map(function(m, i) {
                  return React.createElement(MatchCard, { key: i, item: m });
                })
              ),
              React.createElement('div', { className: 'card' },
                React.createElement('h2', null, '\u26A0\uFE0F Gaps to Address'),
                data.fitAnalysis.gaps.map(function(g, i) {
                  return React.createElement(GapCard, { key: i, item: g });
                })
              )
            )
          ) : null,

          // Reframing Suggestions
          data.fitAnalysis && data.fitAnalysis.reframingSuggestions.length > 0 ? (
            React.createElement('div', { className: 'card fade-in' },
              React.createElement('h2', null, '\uD83C\uDFAF Reframing Suggestions'),
              data.fitAnalysis.reframingSuggestions.map(function(r, i) {
                return React.createElement(ReframeCard, { key: i, item: r });
              })
            )
          ) : null,

          // Deal Breakers and Competitive Advantages
          data.fitAnalysis && (data.fitAnalysis.dealBreakers.length > 0 || data.fitAnalysis.competitiveAdvantages.length > 0) ? (
            React.createElement('div', { className: 'two-col fade-in' },
              data.fitAnalysis.dealBreakers.length > 0 ? React.createElement('div', { className: 'card' },
                React.createElement('h2', null, '\uD83D\uDEA8 Potential Deal Breakers'),
                data.fitAnalysis.dealBreakers.map(function(d, i) {
                  return React.createElement('div', { className: 'list-item', key: i, style: { borderLeft: '3px solid var(--red)' } }, d);
                })
              ) : null,
              data.fitAnalysis.competitiveAdvantages.length > 0 ? React.createElement('div', { className: 'card' },
                React.createElement('h2', null, '\uD83D\uDCAA Competitive Advantages'),
                data.fitAnalysis.competitiveAdvantages.map(function(a, i) {
                  return React.createElement('div', { className: 'list-item', key: i, style: { borderLeft: '3px solid var(--green)' } }, a);
                })
              ) : null
            )
          ) : null,

          // Generated Outputs (from outputs)
          data.outputs ? (
            React.createElement('div', { className: 'fade-in' },
              React.createElement(OutputTabs, { outputs: data.outputs, validation: null })
            )
          ) : data.fitAnalysis ? React.createElement(Skeleton, { height: 200 }) : null
        )
      );
    }

    // --- Results View ---
    function Results({ data }) {
      const { parsedJD, parsedResume, fitAnalysis, metadata, outputs, validation } = data;
      const fit = fitAnalysis;

      return (
        <div>
          <SectionNav />

          {/* Job Overview */}
          <div className="card" id="section-job-overview">
            <h2>&#x1F3E2; Job Overview</h2>
            <div className="job-info">
              <div className="job-field"><label>Company</label><p>{parsedJD.company}</p></div>
              <div className="job-field"><label>Role</label><p>{parsedJD.role}</p></div>
              <div className="job-field"><label>Level</label><p>{parsedJD.level}</p></div>
              {parsedJD.team && <div className="job-field"><label>Team</label><p>{parsedJD.team}</p></div>}
              {parsedJD.salaryRange && <div className="job-field"><label>Salary</label><p>{parsedJD.salaryRange}</p></div>}
            </div>
            <div style={{ marginTop: 16 }}>
              <label>Tech Stack</label>
              <div className="tech-pills">
                {parsedJD.techStack.map((t, i) => <span className="tech-pill" key={i}>{t}</span>)}
              </div>
            </div>
          </div>

          {/* Score */}
          <div className="card score-section" id="section-fit-score">
            <ScoreRing score={fit.overallScore} size={140} />
            <div className="score-label">Overall Fit Score</div>
            <div style={{ marginTop: 4, fontSize: '0.95rem', fontWeight: 600, color: fit.overallScore >= 80 ? 'var(--green)' : fit.overallScore >= 60 ? 'var(--yellow)' : 'var(--red)' }}>
              {getScoreFitLabel(fit.overallScore)}
            </div>
            <div className="stats-row">
              <div className="stat">
                <div className="stat-value" style={{ color: 'var(--green)' }}>{fit.strongMatches.length}</div>
                <div className="stat-label">Strong Matches</div>
              </div>
              <div className="stat">
                <div className="stat-value" style={{ color: 'var(--yellow)' }}>{fit.partialMatches.length}</div>
                <div className="stat-label">Partial Matches</div>
              </div>
              <div className="stat">
                <div className="stat-value" style={{ color: 'var(--red)' }}>{fit.gaps.length}</div>
                <div className="stat-label">Gaps</div>
              </div>
              <div className="stat">
                <div className="stat-value" style={{ color: 'var(--accent-light)' }}>{fit.reframingSuggestions.length}</div>
                <div className="stat-label">Reframe Opps</div>
              </div>
            </div>
          </div>

          {/* Two column: Matches and Gaps */}
          <div className="two-col" id="section-matches">
            <div className="card">
              <h2>&#x2705; Strong Matches</h2>
              {fit.strongMatches.map((m, i) => <MatchCard key={i} item={m} />)}
            </div>
            <div className="card">
              <h2>&#x26A0;&#xFE0F; Gaps to Address</h2>
              {fit.gaps.map((g, i) => <GapCard key={i} item={g} />)}
            </div>
          </div>

          {/* Partial Matches */}
          {fit.partialMatches.length > 0 && (
            <div className="card">
              <h2>&#x1F504; Partial / Transferable Matches</h2>
              {fit.partialMatches.map((m, i) => <MatchCard key={i} item={m} />)}
            </div>
          )}

          {/* Reframing */}
          {fit.reframingSuggestions.length > 0 && (
            <div className="card">
              <h2>&#x1F3AF; Reframing Suggestions</h2>
              {fit.reframingSuggestions.map((r, i) => <ReframeCard key={i} item={r} />)}
            </div>
          )}

          {/* Two column: Deal Breakers and Competitive Advantages */}
          <div className="two-col">
            {fit.dealBreakers.length > 0 && (
              <div className="card">
                <h2>&#x1F6A8; Potential Deal Breakers</h2>
                {fit.dealBreakers.map((d, i) => <div className="list-item" key={i} style={{ borderLeft: '3px solid var(--red)' }}>{d}</div>)}
              </div>
            )}
            {fit.competitiveAdvantages.length > 0 && (
              <div className="card">
                <h2>&#x1F4AA; Competitive Advantages</h2>
                {fit.competitiveAdvantages.map((a, i) => <div className="list-item" key={i} style={{ borderLeft: '3px solid var(--green)' }}>{a}</div>)}
              </div>
            )}
          </div>

          {/* Generated Outputs (Phase 2) */}
          <div id="section-outputs">
            {outputs && <OutputTabs outputs={outputs} validation={validation} />}
          </div>

          {/* Metadata */}
          {metadata && (
            <div className="meta-row" id="section-metadata">
              <span>Model: {metadata.model}</span>
              <span>Total: {metadata.totalDurationMs ?? metadata.durations?.totalMs}ms</span>
              <span>Tokens: {(metadata.tokenUsage?.totalInputTokens ?? 0) + (metadata.tokenUsage?.totalOutputTokens ?? 0)}</span>
              <span>Est. cost: ${metadata.tokenUsage?.estimatedCost?.toFixed(4) ?? '0.00'}</span>
              {metadata.validationAttempts && <span>Validation: {metadata.validationAttempts} attempt{metadata.validationAttempts > 1 ? 's' : ''}</span>}
            </div>
          )}
        </div>
      );
    }

    // --- History View ---
    function HistoryView() {
      const [runs, setRuns] = useState(null);
      const [sort, setSort] = useState('date');
      const [selected, setSelected] = useState(new Set());
      const [comparing, setComparing] = useState(null);
      const [error, setError] = useState('');

      useEffect(() => {
        fetch('/api/runs?sort=' + sort)
          .then(r => r.json())
          .then(data => {
            if (Array.isArray(data)) setRuns(data);
            else setError(data.error || 'Failed to load runs');
          })
          .catch(() => setError('Failed to connect to server'));
      }, [sort]);

      const toggleSelect = useCallback((dir) => {
        setSelected(prev => {
          const next = new Set(prev);
          if (next.has(dir)) next.delete(dir);
          else next.add(dir);
          return next;
        });
      }, []);

      const handleCompare = useCallback(async () => {
        const dirs = Array.from(selected);
        if (dirs.length < 2) return;
        try {
          const res = await fetch('/api/runs/compare', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dirs }),
          });
          const data = await res.json();
          if (data.analyses) setComparing(data.analyses);
          else setError(data.error || 'Compare failed');
        } catch {
          setError('Failed to connect to server');
        }
      }, [selected]);

      if (error) return <div className="error-box">{error}</div>;
      if (!runs) return <div className="card loading"><div className="spinner" /><p>Loading history...</p></div>;

      if (comparing) {
        const cols = comparing.length;
        return (
          <div>
            <div className="toolbar">
              <h2>&#x1F4CA; Comparison</h2>
              <button className="btn btn-sm btn-outline" onClick={() => setComparing(null)}>&#x2190; Back to list</button>
            </div>
            <div className="compare-grid" style={{ gridTemplateColumns: `repeat(${Math.min(cols, 3)}, 1fr)` }}>
              {comparing.map((a, i) => (
                <div className={'compare-card' + (i === 0 ? ' best' : '')} key={a.dir}>
                  {i === 0 && <div style={{ marginBottom: 8 }}><span className="tag tag-strong">Best Fit</span></div>}
                  <h3>{a.company}</h3>
                  <div className="role-text">{a.role}</div>
                  <ScoreRing score={a.score} size={80} />
                  <div style={{ marginTop: 16, textAlign: 'left' }}>
                    <div className="compare-row">
                      <span className="compare-label">Strong Matches</span>
                      <span style={{ color: 'var(--green)', fontWeight: 600 }}>{a.matches}</span>
                    </div>
                    <div className="compare-row">
                      <span className="compare-label">Gaps</span>
                      <span style={{ color: 'var(--red)', fontWeight: 600 }}>{a.gaps}</span>
                    </div>
                    <div className="compare-row">
                      <span className="compare-label">Advantages</span>
                      <span style={{ color: 'var(--blue)', fontWeight: 600 }}>{a.advantages.length}</span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      }

      if (runs.length === 0) {
        return (
          <div className="card empty-state">
            <h3>No analyses found</h3>
            <p>Run an analysis first using the Analyze tab or the CLI.</p>
          </div>
        );
      }

      return (
        <div>
          <div className="toolbar">
            <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
              <span style={{ color: 'var(--text-dim)', fontSize: '0.85rem' }}>{runs.length} application{runs.length !== 1 ? 's' : ''}</span>
              {selected.size >= 2 && (
                <button className="btn btn-sm btn-primary" onClick={handleCompare}>
                  Compare {selected.size} selected
                </button>
              )}
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <label style={{ marginBottom: 0, fontSize: '0.8rem' }}>Sort by:</label>
              <select value={sort} onChange={e => setSort(e.target.value)}>
                <option value="date">Date</option>
                <option value="score">Score</option>
                <option value="cost">Cost</option>
              </select>
            </div>
          </div>

          <div className="card" style={{ padding: 0, overflow: 'hidden' }}>
            <table className="data-table">
              <thead>
                <tr>
                  <th style={{ width: 40 }}></th>
                  <th>Date</th>
                  <th>Company</th>
                  <th>Role</th>
                  <th className="text-center">Score</th>
                  <th className="text-center">Valid</th>
                  <th className="text-right">Cost</th>
                </tr>
              </thead>
              <tbody>
                {runs.map(run => (
                  <tr key={run.dir}>
                    <td>
                      <input
                        type="checkbox"
                        className="checkbox"
                        checked={selected.has(run.dir)}
                        onChange={() => toggleSelect(run.dir)}
                      />
                    </td>
                    <td style={{ color: 'var(--text-dim)', fontSize: '0.85rem' }}>{run.date}</td>
                    <td style={{ fontWeight: 600 }}>{run.company}</td>
                    <td style={{ color: 'var(--text-dim)' }}>{run.role}</td>
                    <td className="text-center">
                      {run.score != null ? <ScoreRing score={run.score} size={44} /> : <span style={{ color: 'var(--text-dim)' }}>--</span>}
                    </td>
                    <td className="text-center">
                      {run.validated === true && <span className="validation-badge validation-passed">&#x2713;</span>}
                      {run.validated === false && <span className="validation-badge validation-failed">&#x2717;</span>}
                      {run.validated == null && <span style={{ color: 'var(--text-dim)' }}>--</span>}
                    </td>
                    <td className="text-right" style={{ fontFamily: 'monospace', fontSize: '0.85rem' }}>
                      {run.cost != null ? '$' + run.cost.toFixed(4) : '--'}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // --- Costs View ---
    function CostsView() {
      const [data, setData] = useState(null);
      const [error, setError] = useState('');

      useEffect(() => {
        fetch('/api/runs/costs')
          .then(r => r.json())
          .then(d => {
            if (d.runs) setData(d);
            else setError(d.error || 'Failed to load costs');
          })
          .catch(() => setError('Failed to connect to server'));
      }, []);

      if (error) return <div className="error-box">{error}</div>;
      if (!data) return <div className="card loading"><div className="spinner" /><p>Loading costs...</p></div>;

      const { runs, totals } = data;

      if (runs.length === 0) {
        return (
          <div className="card empty-state">
            <h3>No cost data</h3>
            <p>Run an analysis first to start tracking costs.</p>
          </div>
        );
      }

      return (
        <div>
          {/* Summary cards */}
          <div className="three-col">
            <div className="card" style={{ textAlign: 'center' }}>
              <div className="stat-label" style={{ marginBottom: 8 }}>Total Input Tokens</div>
              <div className="stat-value" style={{ color: 'var(--blue)' }}>{formatTokens(totals.inputTokens)}</div>
            </div>
            <div className="card" style={{ textAlign: 'center' }}>
              <div className="stat-label" style={{ marginBottom: 8 }}>Total Output Tokens</div>
              <div className="stat-value" style={{ color: 'var(--accent-light)' }}>{formatTokens(totals.outputTokens)}</div>
            </div>
            <div className="card" style={{ textAlign: 'center' }}>
              <div className="stat-label" style={{ marginBottom: 8 }}>Total Cost</div>
              <div className="stat-value" style={{ color: 'var(--green)' }}>${totals.totalCost.toFixed(4)}</div>
            </div>
          </div>

          {/* Per-run table */}
          <div className="card" style={{ padding: 0, overflow: 'hidden' }}>
            <table className="data-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Company</th>
                  <th className="text-right">Input</th>
                  <th className="text-right">Output</th>
                  <th className="text-right">Total</th>
                  <th className="text-right">Cost</th>
                </tr>
              </thead>
              <tbody>
                {runs.map(run => {
                  const input = run.inputTokens ?? 0;
                  const output = run.outputTokens ?? 0;
                  return (
                    <tr key={run.dir}>
                      <td style={{ color: 'var(--text-dim)', fontSize: '0.85rem' }}>{run.date}</td>
                      <td style={{ fontWeight: 600 }}>{run.company}</td>
                      <td className="text-right" style={{ fontFamily: 'monospace', fontSize: '0.85rem' }}>{formatTokens(input)}</td>
                      <td className="text-right" style={{ fontFamily: 'monospace', fontSize: '0.85rem' }}>{formatTokens(output)}</td>
                      <td className="text-right" style={{ fontFamily: 'monospace', fontSize: '0.85rem' }}>{formatTokens(input + output)}</td>
                      <td className="text-right" style={{ fontFamily: 'monospace', fontSize: '0.85rem' }}>${(run.cost ?? 0).toFixed(4)}</td>
                    </tr>
                  );
                })}
                <tr className="totals-row">
                  <td colSpan={2} style={{ fontWeight: 700 }}>TOTAL ({runs.length} run{runs.length !== 1 ? 's' : ''})</td>
                  <td className="text-right" style={{ fontFamily: 'monospace', fontSize: '0.85rem' }}>{formatTokens(totals.inputTokens)}</td>
                  <td className="text-right" style={{ fontFamily: 'monospace', fontSize: '0.85rem' }}>{formatTokens(totals.outputTokens)}</td>
                  <td className="text-right" style={{ fontFamily: 'monospace', fontSize: '0.85rem' }}>{formatTokens(totals.inputTokens + totals.outputTokens)}</td>
                  <td className="text-right" style={{ fontFamily: 'monospace', fontSize: '0.85rem' }}>${totals.totalCost.toFixed(4)}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // --- Progress Stepper ---
    const PIPELINE_STEPS = [
      { key: 'PARSE_JD', label: 'Read Job Posting' },
      { key: 'PARSE_RESUME', label: 'Read Resume' },
      { key: 'ANALYZE_FIT', label: 'Analyze Fit' },
      { key: 'GENERATE_OUTPUTS', label: 'Write Outputs' },
      { key: 'VALIDATE', label: 'Quality Check' },
    ];

    function ProgressStepper({ progressState }) {
      if (!progressState) return null;

      return (
        React.createElement('div', { className: 'card', style: { padding: '24px 32px' } },
          React.createElement('div', { className: 'progress-steps' },
            PIPELINE_STEPS.map(function(step, i) {
              var isActive = progressState.state === step.key;
              var isCompleted = progressState.completedStates && progressState.completedStates.includes(step.key);
              var stepNum = i + 1;

              return React.createElement('div', {
                key: step.key,
                className: 'progress-step' + (isActive ? ' active' : '') + (isCompleted ? ' completed' : '')
              },
                React.createElement('div', { className: 'step-indicator' },
                  isCompleted ? '\u2713' : isActive ? React.createElement('div', { className: 'spinner-sm' }) : stepNum
                ),
                React.createElement('div', { className: 'step-label' }, step.label)
              );
            })
          ),
          React.createElement('div', {
            className: 'progress-bar-track',
            role: 'progressbar',
            'aria-valuenow': progressState.step,
            'aria-valuemin': 0,
            'aria-valuemax': progressState.totalSteps,
            'aria-label': 'Analysis progress'
          },
            React.createElement('div', {
              className: 'progress-bar-fill',
              style: { width: ((progressState.step / progressState.totalSteps) * 100) + '%' }
            })
          ),
          progressState.label && React.createElement('div', {
            className: 'loading-step',
            style: { textAlign: 'center', marginTop: 12 }
          }, progressState.label)
        )
      );
    }

    // --- Skeleton Placeholder ---
    function Skeleton({ height }) {
      return React.createElement('div', {
        className: 'card skeleton-card',
        style: { minHeight: height || 120 }
      });
    }

    // --- Analyze Page ---
    function AnalyzePage() {
      const [jdUrl, setJdUrl] = useState('');
      const [jdText, setJdText] = useState('');
      const [resumeFile, setResumeFile] = useState(null);
      const [resumeText, setResumeText] = useState('');
      const [loading, setLoading] = useState(false);
      const [progressState, setProgressState] = useState(null);
      const [partialResult, setPartialResult] = useState(null);
      const [result, setResult] = useState(null);
      const [error, setError] = useState('');
      const fileInputRef = React.useRef(null);
      const abortRef = React.useRef(null);

      const handleFileChange = useCallback((e) => {
        const file = e.target.files?.[0];
        if (file) {
          const validTypes = ['.pdf', '.txt', '.md'];
          const ext = '.' + file.name.split('.').pop().toLowerCase();
          if (!validTypes.includes(ext)) {
            setError('Supported file types: PDF, TXT, MD');
            return;
          }
          setResumeFile(file);
          setResumeText('');
          setError('');
        }
      }, []);

      const clearFile = useCallback(() => {
        setResumeFile(null);
        if (fileInputRef.current) fileInputRef.current.value = '';
      }, []);

      const handleAnalyze = useCallback(async () => {
        const hasJD = jdUrl.trim() || jdText.trim();
        const hasResume = resumeFile || resumeText.trim();

        if (!hasJD || !hasResume) {
          setError('Please provide both a job description (URL or text) and a resume (file or text).');
          return;
        }

        setLoading(true);
        setError('');
        setResult(null);
        setProgressState({ state: null, step: 0, totalSteps: 5, label: 'Connecting...', completedStates: [] });
        setPartialResult(null);

        abortRef.current = new AbortController();

        try {
          let fetchOpts;
          if (jdUrl.trim() || resumeFile) {
            const formData = new FormData();
            if (jdUrl.trim()) formData.append('jdUrl', jdUrl.trim());
            if (jdText.trim()) formData.append('jdText', jdText.trim());
            if (resumeFile) formData.append('resumeFile', resumeFile);
            if (resumeText.trim()) formData.append('resumeText', resumeText.trim());
            fetchOpts = { method: 'POST', body: formData };
          } else {
            fetchOpts = {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ jdText, resumeText }),
            };
          }

          const res = await fetch('/api/analyze/stream', { ...fetchOpts, signal: abortRef.current.signal });

          if (!res.ok) {
            const errData = await res.json();
            setError(errData.error || 'Analysis failed');
            setLoading(false);
            return;
          }

          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop();

            let currentEvent = null;
            for (const line of lines) {
              if (line.startsWith('event: ')) {
                currentEvent = line.slice(7).trim();
              } else if (line.startsWith('data: ') && currentEvent) {
                try {
                  const data = JSON.parse(line.slice(6));

                  if (currentEvent === 'state') {
                    setProgressState(data);
                  } else if (currentEvent === 'partial') {
                    setPartialResult(function(prev) {
                      var next = Object.assign({}, prev || {});
                      if (data.type === 'parsedJD') next.parsedJD = data.data;
                      if (data.type === 'parsedResume') next.parsedResume = data.data;
                      if (data.type === 'fitAnalysis') next.fitAnalysis = data.data;
                      if (data.type === 'outputs') next.outputs = data.data;
                      return next;
                    });
                  } else if (currentEvent === 'complete') {
                    setResult(data);
                  } else if (currentEvent === 'error') {
                    setError(data.error || 'Analysis failed');
                  }
                } catch (parseErr) {
                  // skip malformed SSE data lines
                }
                currentEvent = null;
              } else if (line.trim() === '') {
                currentEvent = null;
              }
            }
          }
        } catch (err) {
          if (err.name === 'AbortError') return; // user cancelled
          setError('Failed to connect to the server. Is it running?');
        } finally {
          setLoading(false);
        }
      }, [jdUrl, jdText, resumeFile, resumeText]);

      const handleCancel = useCallback(() => {
        if (abortRef.current) abortRef.current.abort();
        setLoading(false);
        setProgressState(null);
        setPartialResult(null);
      }, []);

      // Ctrl/Cmd+Enter to submit
      useEffect(() => {
        const handler = (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'Enter' && !loading) handleAnalyze();
        };
        window.addEventListener('keydown', handler);
        return () => window.removeEventListener('keydown', handler);
      }, [handleAnalyze, loading]);

      if (result) {
        return (
          <div>
            <div style={{ textAlign: 'center', marginBottom: 20 }}>
              <button className="btn btn-primary" onClick={() => { setResult(null); setPartialResult(null); setProgressState(null); setJdUrl(''); setJdText(''); setResumeFile(null); setResumeText(''); setError(''); if (fileInputRef.current) fileInputRef.current.value = ''; }}>
                &#x2190; New Analysis
              </button>
            </div>
            <Results data={result} />
          </div>
        );
      }

      if (loading && (partialResult || progressState)) {
        return (
          <div>
            <ProgressStepper progressState={progressState} />
            <div style={{ textAlign: 'center', marginBottom: 16 }}>
              <button className="btn btn-sm btn-outline" onClick={handleCancel}>Cancel Analysis</button>
            </div>
            <ProgressiveResults data={partialResult} />
            {error && <div className="error-box" style={{ marginTop: 16 }}>{error}</div>}
          </div>
        );
      }

      if (loading) {
        return (
          <div className="card loading">
            <div className="spinner" />
            <h2>Analyzing...</h2>
            <div className="loading-step">Sending to JobFit Agent...</div>
          </div>
        );
      }

      return (
        <div>
          <div className="two-col">
            <div className="card">
              <h2>&#x1F4CB; Job Description</h2>
              <div className="form-group">
                <label>Paste a job posting URL</label>
                <input
                  type="url"
                  value={jdUrl}
                  onChange={e => { setJdUrl(e.target.value); if (e.target.value.trim()) setJdText(''); }}
                  placeholder="https://boards.greenhouse.io/..."
                />
              </div>
              <div className="or-divider">or</div>
              <div className="form-group">
                <label>Paste the job description text</label>
                <textarea
                  value={jdText}
                  onChange={e => { setJdText(e.target.value); if (e.target.value.trim()) setJdUrl(''); }}
                  placeholder="Paste the full job description here..."
                  rows={8}
                />
              </div>
            </div>
            <div className="card">
              <h2>&#x1F4C4; Your Resume</h2>
              <div className="form-group">
                <label>Upload your resume (PDF, TXT, MD)</label>
                <input
                  type="file"
                  ref={fileInputRef}
                  onChange={handleFileChange}
                  accept=".pdf,.txt,.md"
                  style={{ display: 'none' }}
                />
                <div
                  className={'file-upload-area' + (resumeFile ? ' has-file' : '')}
                  onClick={() => fileInputRef.current?.click()}
                  role="button"
                  tabIndex={0}
                  aria-label="Upload resume file"
                  onKeyDown={e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInputRef.current?.click(); } }}
                >
                  {resumeFile ? (
                    <div>
                      <span className="file-name">{resumeFile.name}</span>
                      <button className="file-remove" onClick={e => { e.stopPropagation(); clearFile(); }}>&#x2715; Remove</button>
                    </div>
                  ) : (
                    <div className="file-upload-label">
                      <strong>Click to upload</strong> or drag and drop<br/>
                      PDF, TXT, or MD
                    </div>
                  )}
                </div>
              </div>
              <div className="or-divider">or</div>
              <div className="form-group">
                <label>Paste your resume text</label>
                <textarea
                  value={resumeText}
                  onChange={e => { setResumeText(e.target.value); if (e.target.value.trim()) { setResumeFile(null); if (fileInputRef.current) fileInputRef.current.value = ''; } }}
                  placeholder="Paste your resume text here..."
                  rows={8}
                />
              </div>
            </div>
          </div>

          {error && <div className="error-box" style={{ marginBottom: 16 }}>{error}</div>}

          <div className="btn-center">
            <button className="btn btn-primary" onClick={handleAnalyze} disabled={loading} title="Ctrl+Enter">
              &#x1F50D; Analyze Fit
            </button>
          </div>
        </div>
      );
    }

    // --- Main App ---
    function App() {
      const [page, setPage] = useState('analyze');

      return (
        <div className="app">
          <div className="header">
            <h1>JobFit Agent</h1>
            <p>AI-powered job fit analysis, tracking, and comparison.</p>
          </div>

          <div className="nav" role="tablist" aria-label="Main navigation">
            <button className={'nav-tab' + (page === 'analyze' ? ' active' : '')} onClick={() => setPage('analyze')} role="tab" aria-selected={page === 'analyze'}>
              &#x1F50D; Analyze
            </button>
            <button className={'nav-tab' + (page === 'history' ? ' active' : '')} onClick={() => setPage('history')} role="tab" aria-selected={page === 'history'}>
              &#x1F4CB; History
            </button>
            <button className={'nav-tab' + (page === 'costs' ? ' active' : '')} onClick={() => setPage('costs')} role="tab" aria-selected={page === 'costs'}>
              &#x1F4B0; Costs
            </button>
          </div>

          {page === 'analyze' && <AnalyzePage />}
          {page === 'history' && <HistoryView />}
          {page === 'costs' && <CostsView />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
